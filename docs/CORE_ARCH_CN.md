# 乙羽工具箱 (Yiyu's Toolbox) 核心架构与长期开发指南

> **文档目的**：本档旨在为 AI 助手和人类开发者提供项目的深度技术背景、架构设计思路及未来扩展方向，以确保项目的长期可维护性。

---

## 1. 核心架构设计 (Architecture Overview)

项目采用 **PyQt5** 作为 GUI 框架，底层核心逻辑基于 **PyTorch** 推理。

### 1.1 模块职责划分
- **`src/demo.py` (主控制层)**: 
    - 负责窗口初始化。
    - 管理 `QTabWidget` 切换和全局状态。
    - 连接各个界面的信号与槽。
- **`src/label.py` (核心交互与推理层 - 水印修复)**:
    - **`Label` 类**: 继承自 `QLabel`，实现了复杂的鼠标交互（绘图、缩放、漫游）。
    - **`LaMa` 类**: 封装了 TorchScript 模型的加载与推理逻辑。
- **`src/matting_processor.py` (90分自动抠图核心引擎)**:
    - **`MattingThread` 类**: 封装了 SOTA 级抠图流程。
    - 核心算法：BiRefNet (双向参考网络) + 导向滤波 (Guided Filter) + Sigmoid 边缘锐化。
- **`src/matting_ui.py`**: 抠图功能独立 UI 组件，支持“一键生成 3 种强度”的高效批处理逻辑。
- **`src/video_splitter.py` (独立功能模块)**:
    - 封装了视频镜头检测算法（截取视频分镜）。
- **`src/upscale_processor.py` (90分智能放大核心引擎)**:
    - **`UpscaleThread` 类**: 封装了 Real-ESRGAN 超分流程。
    - 核心特性：多倍率支持、双模型架构 (General 23层 / Anime 6层)、重叠切片处理 (Tile Padding)。
- **`src/upscale_ui.py`**: 智能放大功能独立 UI 组件。
- **`src/batch_processor.py` (去水印批处理)**:
    - 专门处理多图去水印逻辑。

---

## 2. 核心逻辑流 (Core Logic Flow)

### 2.1 AI 去水印流程
1. **输入阶段**: `cv2` 加载图片，生成逻辑蒙版图。
2. **推理**: `LaMa` 类调用 `.pt` 模型执行全局频率感知修复。
3. **输出**: 结果保存至 `images_output_yiyu_box`。

### 2.2 90分自动抠图流程 (精装修级)
1. **模型识别**: 使用 `birefnet-general` 引擎获取原始蒙版。
2. **边缘对齐 (Guided Filter)**: 使用原图作为引导，强迫蒙版边界自动贴合物体真实的色彩边缘。
3. **深度清理 (Strength-dependent)**: 
    - **强模式**: 进行蒙版收缩 (Erosion) + 非线性对比度增强 (Sigmoid Sharpening)。
    - **中/低模式**: 调整滤波半径和 eps 参数，获取更自然的过渡效果。
4. **性能优化**: “一次生成3种”模式通过复用 AI 蒙版减少了 70% 的重复计算时间。

---

## 3. 关键组件说明

- **LaMa 模型**: 用于去水印，擅长处理大面积背景补全。
- **BiRefNet**: SOTA 级抠图模型，对头发丝、眼镜、半透明材质有极强的分辨能力。
- **导向滤波 (Guided Filter)**: 经典的计算机视觉算法，用于将 AI 模糊的边缘“修正”回高频边缘。

---

## 4. 长期开发建议与改进点

- [ ] **模型解耦**: 彻底分离 UI 与模型推理层，建议统一迁移到 `src/engine/`。
- [ ] **多端加速**: 自动检测用户环境，优先使用 `onnxruntime-gpu` 或 `CUDA`。
- [ ] **增强精修**: 
    - 增加手动“背景补全/擦除”的小工具。
    - 支持用户通过上传“引导图”来优化特定复杂背景。
- [ ] **交互增强**: 
    - 增加“撤销/重做”功能。
- [ ] **打包优化**: 持续维护部署脚本，处理 ONNX 和 Torch 运行时的冲突。

---

## 5. 开发规范
- **编码**: 界面显示和用户提示务必使用 **中文**。
- **路径**: 严禁硬编码绝对路径，必须支持 unicode 路径（使用 `cv2.imdecode/imencode` 处理）。
- **线程**: 所有耗时操作必须放入 `QThread`，并在完成后清理 `Session` (暂未实现 Session 销毁逻辑，需注意内存堆积)。

---
*更新日期: 2025-12-25*
